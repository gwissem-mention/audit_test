tinymce.PluginManager.add("image",function(e){function t(e,t){function r(e,r){if(n.parentNode){n.parentNode.removeChild(n)}t({width:e,height:r})}var n=document.createElement("img");n.onload=function(){r(n.clientWidth,n.clientHeight)};n.onerror=function(){r()};var i=n.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(n);n.src=e}function n(t){tinymce.each(t,function(t){t.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[t.value]})}});return t}function r(t){return function(){var n=e.settings.image_list;if(typeof n=="string"){tinymce.util.XHR.send({url:n,success:function(e){t(tinymce.util.JSON.parse(e))}})}else{t(n)}}}function i(r){function h(t,n,r){var i,o=[];tinymce.each(e.settings[t]||r,function(e){var t={text:e.text||e.title,value:e.value};o.push(t);if(s[n]===e.value||!i&&e.selected){i=t}});if(i&&!s[n]){s[n]=i.value;i.selected=true}return o}function p(){var t=[{text:"None",value:""}];tinymce.each(r,function(n){t.push({text:n.text||n.title,value:e.convertURL(n.value||n.url,"src"),menu:n.menu})});return t}function d(){var e,t,n,r;e=i.find("#width")[0];t=i.find("#height")[0];n=e.value();r=t.value();if(i.find("#constrain")[0].checked()&&a&&f&&n&&r){if(a!=n){r=Math.round(n/a*r);t.value(r)}else{n=Math.round(r/f*n);e.value(n)}}a=n;f=r}function v(){function t(t){function n(){t.onload=t.onerror=null;e.selection.select(t);e.nodeChanged()}t.onload=function(){if(!s.width&&!s.height){o.setAttribs(t,{width:t.clientWidth,height:t.clientHeight})}n()};t.onerror=n}b();d();s=tinymce.extend(s,i.toJSON());if(!s.alt){s.alt=""}if(s.width===""){s.width=null}if(s.height===""){s.height=null}if(s.style===""){s.style=null}s={src:s.src,alt:s.alt,width:s.width,height:s.height,style:s.style,title:s.alt,"class":s["class"]};if(!s["class"]){delete s["class"]}e.undoManager.transact(function(){if(!s.src){if(u){o.remove(u);e.focus();e.nodeChanged()}return}if(!u){s.id="__mcenew";e.focus();e.selection.setContent(o.createHTML("img",s));u=o.get("__mcenew");o.setAttrib(u,"id",null)}else{o.setAttribs(u,s)}t(u)})}function m(e){if(e){e=e.replace(/px$/,"")}return e}function g(){if(l){l.value(e.convertURL(this.value(),"src"))}t(this.value(),function(e){if(e.width&&e.height){a=e.width;f=e.height;i.find("#width").value(a);i.find("#height").value(f)}})}function b(){function t(e){if(e.length>0&&/^[0-9]+$/.test(e)){e+="px"}return e}if(!e.settings.image_advtab){return}var n=i.toJSON();var r=o.parseStyle(n.style);delete r.margin;r["margin-top"]=r["margin-bottom"]=t(n.vspace);r["margin-left"]=r["margin-right"]=t(n.hspace);r["border-width"]=t(n.border);i.find("#style").value(o.serializeStyle(o.parseStyle(o.serializeStyle(r))))}var i,s={},o=e.dom,u=e.selection.getNode();var a,f,l,c;a=o.getAttrib(u,"width");f=o.getAttrib(u,"height");if(u.nodeName=="IMG"&&!u.getAttribute("data-mce-object")&&!u.getAttribute("data-mce-placeholder")){s={src:o.getAttrib(u,"src"),alt:o.getAttrib(u,"alt"),"class":o.getAttrib(u,"class"),width:a,height:f}}else{u=null}if(r){l={type:"listbox",label:"Image list",values:p(),value:s.src&&e.convertURL(s.src,"src"),onselect:function(e){var t=i.find("#alt");if(!t.value()||e.lastControl&&t.value()==e.lastControl.text()){t.value(e.control.text())}i.find("#src").value(e.control.value())},onPostRender:function(){l=this}}}if(e.settings.image_class_list){c={name:"class",type:"listbox",label:"Class",values:n(h("image_class_list","class"))}}var y=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:g},l];if(e.settings.image_description!==false){y.push({name:"alt",type:"textbox",label:"Image description"})}if(e.settings.image_dimensions!==false){y.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:d,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:d,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}y.push(c);if(e.settings.image_advtab){if(u){s.hspace=m(u.style.marginLeft||u.style.marginRight);s.vspace=m(u.style.marginTop||u.style.marginBottom);s.border=m(u.style.borderWidth);s.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(u,"style")))}i=e.windowManager.open({title:"Insert/edit image",data:s,bodyType:"tabpanel",body:[{title:"General",type:"form",items:y},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:b},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:v})}else{i=e.windowManager.open({title:"Insert/edit image",data:s,body:y,onSubmit:v})}}e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:r(i),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});e.addMenuItem("image",{icon:"image",text:"Insert image",onclick:r(i),context:"insert",prependToContext:true})})