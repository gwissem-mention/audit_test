{% import _self as mySelf %}

<div id="resultats">
    <div class="col-md-12">
        <a href="{{path('hopitalnumerique_autodiag_front_resultat_pdf', {'id':resultat.id})}}" class="print btn btn-default pull-right" title="Télacharger les résultats en PDF"><i class="fa fa-download"></i></a>

        {% if back is defined and back %}
            <a href="{{path('hopitalnumerique_autodiag_front_comptehn')}}" class="print btn btn-success pull-left" title="Retour à mon compte"><i class="fa fa-reply"></i></a>
        {% else %}
            <a href="{{path('hopitalnumerique_autodiag_front_outil', { 'alias':resultat.outil.alias, 'outil':resultat.outil.id })}}" class="print btn btn-success pull-left" title="Retour au questionnaire"><i class="fa fa-reply"></i></a>
        {% endif %}

        {% if pdf %}
            <img src="{{app.request.getSchemeAndHttpHost() ~ asset('bundles/hopitalnumeriquecore/img/anap.jpg')}}" alt="Logo anap" class="pull-left" />
        {% endif %}

        <h1 class="text-center">{{resultat.outil.title}}</h1>

        <div class="clearfix"></div>

        {% if resultat.synthese %}
            <div class="autodiags">
                <h2 class="violet open" data-toggle="results" >Synthèse - {{resultat.name}}</h2>
                
                <div id="results">
                    <p>Autodiagnostics concernés par cette synthèse :</p>
                    <ul>
                        {% for result in resultat.resultats %}
                            <li><a href="{{path('hopitalnumerique_autodiag_front_resultat', {'id':result.id, 'back':1})}}" target="_blank">{{result.name}}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="page-break"></div>
        {% endif %}

        <h2 class="violet open" data-toggle="graphiques" >Résultats de l'outil - Graphiques</h2>

        <div id="graphiques">
            {# Affichage du graphique barre #}
            {% if graphiques['barre'] is defined %}
                {% set chart = graphiques['barre'] %}
                <h3>{{chart.title|capitalize}}</h3>
                <div class="row" id="graphiques-barres" >
                    {% for panel in chart.panels %}
                        {% set tauxChapitre = panel.taux|number_format(0) %}
                        <div class="col-md-6">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">{{panel.title}}</h3>
                                    <div class="options">
                                        {% if panel.value|checkNC %}
                                            {% if tauxChapitre == 0 %}
                                                Score : NC
                                            {% else %}
                                                Score : {{panel.value|number_format(0)}}%
                                            {% endif %}

                                            {% if tauxChapitre == 0 %}
                                                <img src="{{asset('bundles/hopitalnumeriqueautodiag/img/niv-4.png')}}" alt="Taux Remplissage" title="Taux de remplissage : {{tauxChapitre}}%" />
                                            {% elseif tauxChapitre <= 33 %}
                                                <img src="{{asset('bundles/hopitalnumeriqueautodiag/img/niv-3.png')}}" alt="Taux Remplissage" title="Taux de remplissage : {{tauxChapitre}}%" />
                                            {% elseif tauxChapitre <= 66 %}
                                                <img src="{{asset('bundles/hopitalnumeriqueautodiag/img/niv-2.png')}}" alt="Taux Remplissage" title="Taux de remplissage : {{tauxChapitre}}%" />
                                            {% else %}
                                                <img src="{{asset('bundles/hopitalnumeriqueautodiag/img/niv-1.png')}}" alt="Taux Remplissage" title="Taux de remplissage : {{tauxChapitre}}%" />
                                            {% endif %}
                                        {% else %}
                                            Score : NC

                                            <img src="{{asset('bundles/hopitalnumeriqueautodiag/img/niv-4.png')}}" alt="Taux Remplissage" title="Taux de remplissage : 0%" />
                                        {% endif %}
                                    </div>
                                    <div class="clearfix"></div>
                                </div>

                                <div class="panel-body">
                                    <h3 class="toPrint">{{panel.title}}</h3>
                                    {% if panel.value|checkNC %}
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-danger" style="width: 33.3%">
                                                Faible
                                            </div>
                                            <div class="progress-bar progress-bar-warning" style="width: 33.3%">
                                                Moyen
                                            </div>
                                            <div class="progress-bar progress-bar-success" style="width: 33.3%">
                                                Fort
                                            </div>

                                            {% if tauxChapitre != 0 %}
                                                {% set value = panel.value|number_format(0) ~ '%' %}
                                                <div class="cursor" {% if pdf %}style="left:{{value}}"{% endif %} data-position="{{value}}" title="<span>Score : {{value}}</span>" ></div>
                                                {% if pdf %}
                                                    <div class="cursor-value" style="left:{{value}}">{{value}}</div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <p class="text-center">- Le chapitre n'a pas été diagnostiqué -</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="page-break"></div>
            {% endif %}
            
            {# Affichage de la restitution par processus #}
            {% if processusDonnees is defined and processusDonnees|length > 0 %}
                <div id="process_bloc">
                    <h3>{{ resultat.outil.processChartLabel }}</h3>
                    {% for process in processusDonnees %}
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">{{ process.libelle }}</h3>
                                <div class="clearfix"></div>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    {% for chapitre in process.chapitres %}
                                        <div class="col-md-4">
                                            <h4 class="text-center">{{ chapitre.titre }}</h4>
                                            <div class="chapitres">
                                                {% for chapitreEnfant in chapitre.enfants %}
                                                    <div class="resultat{% if chapitreEnfant.nombreQuestionsRepondues > 0 %} {% if chapitreEnfant.moyenne > 66 %} resultat_fort{% elseif chapitreEnfant.moyenne > 33 %}resultat_moyen{% else %}resultat_faible{% endif %}{% endif %}"{% if chapitreEnfant.nombreQuestionsRepondues > 0 %} title="Score : {{ chapitreEnfant.moyenne }}%"{% endif %}>{{ chapitreEnfant.titre }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    {% endfor %}
                </div>
                <div class="page-break"></div>
            {% endif %}
            
            {# Affichage du graphique spider #}
            {% if graphiques['radar'] is defined %}
                {% set chart = graphiques['radar'] %}
                <h3>{{chart.title|capitalize}}</h3>
                <div class="row">
                    <div id="radarChart"></div>
                    <input type="hidden" id="datas-radar" value="{{chart.datas|json_encode()}}">
                    <div class="col-md-12">
                        <p id="chaptersNonConcernes"></p>
                    </div>
                </div>
                <div class="page-break"></div>
            {% endif %}

            {# Affichage du graphique tableau #}
            {% if graphiques['table'] is defined %}
                {% set chart = graphiques['table'] %}
                <h3>{{chart.title|capitalize}}</h3>
                <div class="row">
                    <div class="col-md-12 tableContainer">
                        <table class="table table-hover table-bordered" id="tableau_resultats" >
                            <thead>
                                <th colspan="2" class="text-center vertical-align">
                                    <div class="reverse" onclick="reverse_table(document.getElementById('tableau_resultats'));" ><i class="fa fa-refresh"></i></div>
                                </th>
                                {% for id, chapitre in chart.datas.chapitres %}
                                    <th class="active text-center chapitre-{{id}}">{{chapitre|capitalize}}</th>
                                {% endfor %}
                                <th class="active text-center title-total">Total</th>
                            </thead>
                            <tbody>
                                {% for id,categorie in chart.datas.categories %}
                                    {% set nbRepCateg = 0 %}
                                    {% set nbQueCateg = 0 %}
                                    {% set nbPointsCateg = 0 %}
                                    {% set maxCateg = 0 %}

                                    <tr>
                                        <td class="active text-center vertical-align categorie-{{id}}" rowspan="2"><b>{{categorie.title|capitalize}}</b></td>
                                        <td class="text-center">Nombre de réponses</td>
                                        {% for datas in categorie['chapitres'] %}
                                            {% if not datas['nc'] %}
                                                <td class="text-center">
                                                    {{datas['nbRep']}} / {{datas['nbQue']}}
                                                </td>
                                                {% set nbRepCateg = nbRepCateg + datas['nbRep'] %}
                                                {% set nbQueCateg = nbQueCateg + datas['nbQue'] %}
                                            {% else %}
                                                <td class="text-center vertical-align">
                                                    - Non diagnostiqué -
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                        <td class="text-center">
                                            {{nbRepCateg}} / {{nbQueCateg}}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-center">Score</td>
                                        {% for datas in categorie['chapitres'] %}
                                            {% if not datas['nc'] %}
                                                {% if datas['max'] != 0 %}
                                                    {% set note = (datas['nbPoints'] * 100) / datas['max'] %}
                                                {% else %}
                                                    {% set note = 0 %}
                                                {% endif %}
                                                <td class="text-center {% if note <= 33 %}danger{% elseif note <= 66 %}warning{% else %}success{% endif %}">
                                                    {{ note|number_format(0) }}%
                                                </td>
                                            {% else %}
                                                <td class="text-center vertical-align" >
                                                    NC
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                        {% if maxCateg != 0 %}
                                            {% set note = (nbPointsCateg * 100) / maxCateg %}
                                        {% else %}
                                            {% set note = 0 %}
                                        {% endif %}
                                        <td data-categorie="{{id}}" class="total-categorie text-center {% if note <= 33 %}danger{% elseif note <= 66 %}warning{% else %}success{% endif %}">
                                            {{ note|number_format(0) }}%
                                        </td>
                                    </tr>
                                {% endfor %}

                                {% if chart.datas.categories|length > 1 %}
                                    <tr>
                                        <td class="text-center title-total vertical-align" rowspan="2"><b>Total</b></td>
                                        <td class="text-center">Nombre de réponses</td>
                                        {% set nbRepTotal = 0 %}
                                        {% set nbQueTotal = 0 %}
                                        {% for datas in chart.datas.totauxChapitres %}
                                            {% if not datas['nc'] %}
                                                <td class="text-center">
                                                    {{datas['nbRep']}} / {{datas['nbQue']}}
                                                </td>
                                                {% set nbRepTotal = nbRepTotal + datas['nbRep'] %}
                                                {% set nbQueTotal = nbQueTotal + datas['nbQue'] %}
                                            {% else %}
                                                <td class="text-center vertical-align">
                                                    - Non diagnostiqué -
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                        <td class="text-center">
                                            {{nbRepTotal}} / {{nbQueTotal}}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-center">Score</td>
                                        {% for idChapitre,datas in chart.datas.totauxChapitres %}
                                            {% if not datas['nc'] %}
                                                {% if datas['max'] != 0 %}
                                                    {% set note = (datas['nbPoints'] * 100) / datas['max'] %}
                                                {% else %}
                                                    {% set note = 0 %}
                                                {% endif %}
                                                <td data-chapitre="{{idChapitre}}" class="total-chapitre text-center {% if note <= 33 %}danger{% elseif note <= 66 %}warning{% else %}success{% endif %}">
                                                    {{ note|number_format(0) }}%
                                                </td>
                                            {% else %}
                                                <td class="text-center vertical-align" >
                                                    NC
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                        {% if maxTotal != 0 %}
                                            {% set note = (nbPointsTotal * 100) / maxTotal %}
                                        {% else %}
                                            {% set note = 0 %}
                                        {% endif %}
                                        <td class="last-note text-center {% if note <= 33 %}danger{% elseif note <= 66 %}warning{% else %}success{% endif %}">
                                            {{ note|number_format(0) }}%
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            <div class="clearfix"></div>
        </div>
        
        <div class="page-break"></div>

        <h2 class="violet closed" data-toggle="chapitres" >Résultats de l'outil - Analyse</h2>

        <div id="chapitres" style="display:none">
            <p class="text-justify">
                <span>Compte tenu de vos réponses, l'Anap vous propose l'analyse suivante (l'ordre d'affichage correspond à l'ordre de priorité de traitement, le plus important en premier) :</span>
            </p>

            <style type="text/css">
                #chapitres #table-analyse td, #table-analyse th {font-size: 11px;}
            </style>
            <script type="text/javascript">
                $(window).load(function() {
                    $('#chapitres #table-analyse thead tr th.forPrint').css('display', 'none');
                    $('#chapitres #table-analyse tbody tr td.forPrint').css('display', 'none');
                });
            </script>

            {# Affichage des publications sous forme de tableau : GME 24/09/14 #}
            <table class="table table-striped" id="table-analyse">
                <!-- En-tête du tableau -->
                <thead>
                    <tr>
                       <th>Chapitre</th>
                       <th>Sous-chapitre</th>
                       <th>Question</th>
                       <th>Réponse</th>
                       <th>Synthèse</th>
                       <th class="forAffichage">Production</th>
                       <th class="forPrint" style="width:100px;">Commentaire</th>
                    </tr>
                </thead>
                
                <!-- Corps du tableau -->
                <tbody>
                    {# Chapitres #}
                    {% set chaptersToHide = [] %}
                    {% for chapitre in chapitres %}
                        {% set doTheChapterHavePublications = false %}
                        <tr>
                            <td>{{chapitre.title}}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            {% if chapitre.synthese %}
                                <td>{{chapitre.synthese|nl2br}}</td>
                            {% else %}
                                <td></td>
                            {% endif %}
                            <td class="forAffichage">
                                {% if chapitre.noteMin and chapitre.noteChapitre <= chapitre.noteMin %}
                                    {% set publications = chapitre.id|getPublicationsForChapitre(pdf) %}
                                    {% if publications %}
                                        {{publications|raw}}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="forPrint"></td>
                        </tr>
                        
                        {# Questions du chapitre #}
                        {% for question in chapitre.questions %}
                            <tr>
                                <td></td>
                                <td></td>
                                <td>{{question.question}}</td>
                                <td {% if question.colored and question.initialValue != -1 and question.initialValue != '' %}
                                        {% if question.min == question.initialValue %}
                                            style="color:#c82f5b"
                                        {% elseif question.max == question.initialValue %}
                                            style="color:#e88824"
                                        {% else %}
                                            style="color:#e88824"
                                        {% endif %}{% endif %}>
                                    {% if question.initialValue == -1 %}
                                        Non concerné
                                    {% else %}
                                        {% for option in question.options %}
                                            {% set tab = option|split(';') %}
                                            {% if tab[0] == question.initialValue %}
                                                {{tab[1]|trim}}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                {% if question.synthese %}
                                    <td>{{question.synthese|nl2br}}</td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                                <td class="forAffichage">
                                    {% set publications = question.id|getPublicationsForQuestion(pdf) %}
                                    {% if publications %}
                                        {{publications|raw}}
                                        {% set doTheChapterHavePublications = true %}
                                    {% endif %}
                                </td>
                                <td class="forPrint"></td>
                            </tr>
                        {% endfor %}

                        {# Sous Chapitres #}
                        {% if chapitre.childs|length > 0 %}
                            {% for child in chapitre.childs %}
        
                                <tr>
                                    <td></td>
                                    <td>{{child.title}}</td>
                                    <td></td>
                                    <td></td>
                                    {% if child.synthese %}
                                        <td>{{child.synthese|nl2br}}</td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                    <td class="forAffichage">
                                        {% if child.noteMin and child.noteChapitre <= child.noteMin %}
                                            {% set publications = child.id|getPublicationsForChapitre(pdf) %}
                                            {% if publications %}
                                                {{publications|raw}}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="forPrint"></td>
                                </tr>

                                {# Question du sous chapitre #}
                                {% for questionChild in child.questions %}
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td>{{questionChild.question}}</td>
                                        <td {% if questionChild.colored and questionChild.initialValue != -1 and questionChild.initialValue != '' %}
                                                {% if questionChild.min == questionChild.initialValue %}
                                                    style="color:#c82f5b"
                                                {% elseif questionChild.max == questionChild.initialValue %}
                                                    style="color:#e88824"
                                                {% else %}
                                                    style="color:#e88824"
                                                {% endif %}{% endif %}>
                                            {% if questionChild.initialValue == -1 %}
                                                Non concerné
                                            {% else %}
                                                {% for option in questionChild.options %}
                                                    {% set tab = option|split(';') %}
                                                    {% if tab[0] == questionChild.initialValue %}
                                                        {{tab[1]|trim}}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                        {% if questionChild.synthese %}
                                            <td>{{questionChild.synthese|nl2br}}</td>
                                        {% else %}
                                            <td></td>
                                        {% endif %}
                                        <td class="forAffichage">
                                            {% set publications = questionChild.id|getPublicationsForQuestion(pdf) %}
                                            {% if publications %}
                                                {{publications|raw}}
                                                {% set doTheChapterHavePublications = true %}
                                            {% endif %}
                                        </td>
                                        <td class="forPrint"></td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td colspan="5">Compte tenu de vos réponses, l' ANAP n'a pas de recommendation pour vous.</td>
                                    </tr>
                                
                                {% endfor %}

                            {% endfor %}
                        {% endif %}

                        {% if not doTheChapterHavePublications %}
                            {% set chaptersToHide = chaptersToHide|merge([chapitre.id]) %}
                        {% endif %}

                    {% endfor %}
                </tbody>
            </table>

            <p class="text-center {% if chapitres|length > 0 %}hide{% endif %}" >
                - Aucune recommandation de l'ANAP nécessaire -
                <input type="hidden" id="chaptersToHide" value="{{chaptersToHide|json_encode}}" />
            </p>
        </div>
        
        {% if pdf or true %}
            <div class="page-break"></div>

            <h2 class="violet closed" data-toggle="reponses" >Résultats de l'outil - Vos réponses</h2>

            <div id="reponses" {% if not pdf %} style="display:none" {% endif %} >
            
                <p>Vos réponses apparaissent en gras parmi les réponses possibles à chaque question.</p>
            
                {% if resultat.remarque is defined %}
                    <p class="text-muted"><em>{{ resultat.remarque|raw|nl2br }}</em></p>
                {% endif %}
            
                {% for chapitre in chapitres %}
                    {% if chapitre.nbQuestionsRemplies > 0 %}
                        <div class="chapitre-{{chapitre.id}}">
                            <h3 class="prev">{{chapitre.intro}}</h3>
                            <h3 class="violet">{{chapitre.title}}</h3>
                            <p class="text-muted level1">{{chapitre.desc}}</p>
                            
                            <hr>
    
                            {% if chapitre.questionsBack|length > 0 %}
                                {{ mySelf.buildQuestionReponse(chapitre.questionsBack) }}
                            {% endif %}
                            
                            {% if chapitre.childs|length > 0 %}
                                <div class="row sous-chapitre col-md-12">
                                    {% for child in chapitre.childs %}
                                        {% if child.nbQuestionsRemplies > 0 %}
                                            <h4 class="prev">{{child.intro}}</h4>
                                            <h4 class="violet">{{child.title}}</h4>
                                            <p class="text-muted level1">{{child.desc}}</p>
                                            
                                            {{ mySelf.buildQuestionReponse(child.questionsBack) }}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="clearfix"></div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

{% macro buildQuestionReponse(questions) %}
    {% for question in questions %}
        {% if question.initialValue != '' and question.initialValue != -1 %}
            <div class="clearfix">
                <p class="text-muted">{{question.intro}}</p>
                <div>
                    <p>
                        {{question.question}} : 
                    </p>
                </div>
                
                <div>
                    {% set options = question.options %}
                    <p class="pull-left">
                        {% if question.initialValue != -1 %}
                            <span>Non concerné</span><br />
                        {% else %}
                            <span><b>Non concerné</b></span><br />
                        {% endif %}
                        
                        {% for option in options %}
                            {% set tab = option|split(';') %}
                            {% if tab[0] == question.initialValue %}
                                <span><b>{{tab[1]|trim}}</b></span> &nbsp; <em class="text-muted">{{question.remarque}}</em><br />
                            {% else %}
                                <span>{{tab[1]|trim}}</span><br />
                            {% endif %}
                        {% endfor %}
                    </p>
                    {% if question.colored and question.initialValue != -1 and question.initialValue != '' %}
                        <div class="icon pull-right">
                            {% if question.min == question.initialValue %}
                                <img src="{{app.request.getSchemeAndHttpHost() ~ asset('bundles/hopitalnumeriqueautodiag/img/bad.jpg')}}" class="pull-right" alt="bad" />
                            {% elseif question.max == question.initialValue %}
                                <img src="{{app.request.getSchemeAndHttpHost() ~ asset('bundles/hopitalnumeriqueautodiag/img/good.jpg')}}" class="pull-right" alt="good" />
                            {% else %}
                                <img src="{{app.request.getSchemeAndHttpHost() ~ asset('bundles/hopitalnumeriqueautodiag/img/bof.jpg')}}" class="pull-right" alt="bof" />
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}