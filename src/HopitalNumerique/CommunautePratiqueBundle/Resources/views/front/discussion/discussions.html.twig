{% trans_default_domain 'cdp_discussion' %}

{% block javascripts %}
    <script type="text/javascript">
        $(document).ready(function() {
            new Discussion('{{ scope }}');
        });
    </script>
{% endblock %}

{% if newDiscussionForm is not null %}
    <div id="new-discussion-modal" class="modal fade">
        {{ form_start(newDiscussionForm) }}
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">{{ 'discussion.new_discussion.text'|trans }}</h4>
                </div>
                <div class="modal-body">
                    {{ form_row(newDiscussionForm.title, {'attr': {'class': 'validate[required]'}}) }}
                    {{ form_row(newDiscussionForm.content, {'attr': {'class': 'validate[required]'}}) }}
                </div>
                <div class="modal-footer">
                    <input type="submit" class="btn btn-success" value="{{ 'discussion.new_discussion.form.submit.text'|trans|e }}">
                </div>
            </div>
        </div>
        {{ form_end(newDiscussionForm) }}
    </div>
{% endif %}

<div class="discussions" data-base-url="{{ scope == 'public' ? path('hopitalnumerique_communautepratique_discussions_public') : path('hopitalnumerique_communautepratique_groupe_view', {'groupe': group.id})~'#discussion' }}">
    {% if newDiscussionForm is not null %}
        <div class="add">
            <a href="#" class="add-btn" data-toggle="modal" data-target="#new-discussion-modal">
                <i class="icon fa fa-plus-circle"></i>
                {{ 'discussion.new_discussion.text'|trans }}
            </a>
        </div>
    {% endif %}
    <div class="wrapper">
        {% set lazyLoadStep = 10 %}
        <div class="list" data-lazyload-step="{{ lazyLoadStep }}">
            {% set displayedItemsCount = 20 %}
            {% set currentDiscussionToShow = currentDiscussion is not null %}
            {% for discussion in discussions %}
                {% set isStaredItem = discussion.hasHelpfulMessage or discussion.recommended %}
                {% spaceless %}

                    {% set hidden = false %}
                    {% if loop.index > displayedItemsCount %}
                        {% set hidden = true %}
                        {% if currentDiscussionToShow == true %}
                            {% set displayedItemsCount = displayedItemsCount + lazyLoadStep %}
                            {% set hidden = false %}
                        {% endif %}
                    {% endif %}

                    {% if not currentDiscussion or currentDiscussion.id == discussion.id %}
                        {% set currentDiscussionToShow = false %}
                    {% endif %}

                    <a
                        href="{{ path('hopitalnumerique_communautepratique_discussions_discussion', {'discussion': discussion.id, 'group': group ? group.id : null}) }}"
                        data-url="{{ scope == 'public' ? path('hopitalnumerique_communautepratique_discussions_public_desfult_discussion', {'discussion': discussion.id}) : path('hopitalnumerique_communautepratique_groupe_view_default_discussion', {'groupe': group.id, 'discussion': discussion.id}) }}"
                        class="item{{ hidden ? ' hidden' }}{{ currentDiscussion and discussion.id == currentDiscussion.id ? ' active'}}{{ isStaredItem ? ' stared' }}"
                    >
                        {% if app.user is not null and discussion.newMessageCount(app.user) > 0 %}
                            <span class="icon new-message-badge" title="{{ 'discussion.list.item.new_message_count'|transchoice(discussion.newMessageCount(app.user))|e }}">
                                {{ discussion.newMessageCount(app.user) }}
                            </span>
                        {% endif %}

                        {% if discussion.hasHelpfulMessage %}
                            <i class="icon fa fa-star"></i>
                        {% endif %}

                        {% if discussion.recommended %}
                            <i class="icon fa fa-thumbs-o-up"></i>
                        {% endif %}

                        <span class="title">
                            {{ discussion.title }}
                        </span>

                        <span class="infos">
                            {{ 'discussion.list.item.message_count'|transchoice(discussion.messages|length, {'%messageCount%': '<b>'~discussion.messages|length~'</b>'})|raw }} -
                            {{ 'discussion.list.item.last_message'|trans({'%date%': '<b>'~discussion.messages.first.createdAt|localizeddate('short', 'none')~'</b>', '%author%': '<b>'~discussion.messages.last.user.prenomNom~'</b>'})|raw }}<br />
                            {{ 'discussion.list.item.created_at'|trans({'%date%': '<b>'~discussion.createdAt|localizeddate('short', 'none')~'</b>'})|raw }}<br />
                        </span>
                    </a>
                {% endspaceless %}
            {% endfor %}

            <div class="load-more">
                <a href="#" class="btn btn-sm btn-default">{{ 'discussion.list.load_more'|trans }}</a>
            </div>
        </div>

        <div class="discussion">
            {% if currentDiscussion is not null %}
                {{ include('HopitalNumeriqueCommunautePratiqueBundle:front/discussion:discussion.html.twig', {'discussion': currentDiscussion}) }}
            {% endif %}
        </div>
    </div>
</div>
