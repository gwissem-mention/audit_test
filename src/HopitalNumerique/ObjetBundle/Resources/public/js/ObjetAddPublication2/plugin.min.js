tinymce.PluginManager.add('publication', function(editor, url) {
    
    // retourne le texte sélectionné au moment du clic
    function getTextValue() {
        return editor.selection.getContent({format: 'text'});
    }

    function getCibles() {
        return [
            {text: "n/a", value: 0},
            {text: "Nouvelle Fenêtre", value : 1}
        ];
    }

    // Add a button that opens a window
    editor.addButton('publication', {
        text: 'Ajouter un lien interne',
        icon: false,
        onclick: function() {
            $.ajax({
                url: editor.settings.urlPublication,
                type: "POST",
                data: editor.settings.paramsPublication,
                dataType: "JSON",
                success: function(data) {
                    editor.windowManager.open({
                        title: 'Ajouter un lien interne',
                        body: [
                            {type: 'listbox', name: 'publication', label: 'Publication', values: data},
                            {type: 'textbox', name: 'texte', label: 'Texte à afficher', value: getTextValue()},
                            {type: 'listbox', name: 'cible', label: 'Cible', values: getCibles()}
                        ],
                        onsubmit: function(e) {
                            // Insert content when the window form is submitted
                            if( e.data.cible == 1 ){
                                editor.insertContent('[' + e.data.publication + ';' + e.data.texte + ';' + e.data.cible + ']');
                            } else {
                                editor.insertContent('[' + e.data.publication + ';' + e.data.texte + ']');
                            }
                        }
                    });
                }
            });
        }
    });
});