<div class="panel panel-midnightblue" style="margin:0" >
    <div class="panel-heading" style="height:65px">
        <h4 style="line-height:22px; padding:0">Aide à l'expression du besoin</h4>
    </div>
    <div class="clearfix"></div>

    <div id="panel-recherche">
        <div class="tableContent" id="expression-du-besoin">
            {% for expBesoin in expBesoins %}
                <div id="expBesoin-{{expBesoin.id}}" class="expression-du-besoin-form" data-id="{{expBesoin.id}}">
                    {% include "HopitalNumeriqueRechercheBundle:ExpBesoin:Fancy/Partial/expbesoin_formulaire.html.twig" with { 'expBesoin':expBesoin } %}
                </div>
            {% endfor %}

            <div id="redirection-references">
                <div class="resume col-md-12">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque sit amet est et est mollis rhoncus a eu dolor. Pellentesque adipiscing lacinia magna id tempus. Ut non iaculis eros. Morbi sagittis magna nec dui molestie, vel sodales sem dapibus cras amet. <a href="{{path("hopital_numerique_recherche_homepage")}}">Atteindre la recherche.</a></div>
            </div>

            <input type="hidden" id="expBesoin-actif-id" value="" />
            <input type="hidden" id="reponses-json" value="{{ reponses }}" />
        </div>
        <div class="clearfix"></div>

        <input type="hidden" id="url-modification-session-recherche" value="{{ path("hopital_numerique_expbesoin_modification_session_recherche") }}" />
        
        <div class="panel-footer" >
            <div class="row">
                <div class="btn-toolbar pull-right" style="margin:0 10px 0 0;">
                    <div onclick="$.fancybox.close(true);" class="btn-danger btn">Fermer</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" >
    $(document).ready(function() {
        //Cache le bloc de références
        $('#redirection-references').hide();
        //Cache toutes les questions
        $('#expression-du-besoin .expression-du-besoin-form').each(function(){
            $(this).hide();
        });

        //Ré-Affiche la première question (l'ordre le plus bas)
        $('#expression-du-besoin .expression-du-besoin-form').first().show();

        //Assigne la fonction de gestion de la question suivante ou de référencement sur le changement dans un select
        $('#expression-du-besoin .expression-du-besoin-form select').change(function(){
            //Récupération des réponses
            var reponses = $.parseJSON($('#reponses-json').val());

            //Récupération de la réponse courante
            var reponsesCourante = reponses[$(this).val()];

            //Cache la question courante
            $(this).parents('.expression-du-besoin-form').hide();

            //Vérifie si on pointe sur une nouvelle question ou si on doit rediriger vers la recherche
            if(reponsesCourante['autreQuestion'])
            {
                //Affiche celle sur laquelle la réponse pointe
                $(this).parents('#expression-du-besoin').find('#expBesoin-' + reponsesCourante['idQuestion']).show();
            }
            else
            {
                var loader = $('#expression-du-besoin').nodevoLoader().start();
                var path   = $('#url-modification-session-recherche').val();

                //Génération du cookie JS pour la recherche
                $.ajax({
                    url      : path,
                    data : {
                        id : $(this).val()
                    },
                    type     : 'POST',
                    dataType : 'json',
                    success : function( data ){
                        loader.finished();
                        if( data.success )
                        {
                            //Affichage du bloc
                            $('#redirection-references').show();
                        }
                        else
                        {
                            apprise('Une erreur est survenue lors du chargement du calcul de votre recherche, merci de réessayer.');
                        }
                    }
                });
            }
        });
    });
</script>