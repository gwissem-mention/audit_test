<?php

namespace HopitalNumerique\RechercheParcoursBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * MaitriseUserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MaitriseUserRepository extends EntityRepository
{
    /**
     * Retourne la moyenne des notes pour les étapes passées en param
     *
     * @param array $etapesId [description]
     *
     * @return QueryBuilder
     */
    public function getAverage(array $etapesId, $user)
    {
        return $this->_em->createQueryBuilder()
                         ->select('etape.id as etapeId, avg(notes.pourcentageMaitrise) as moyenne')
                         ->from('\HopitalNumerique\RechercheParcoursBundle\Entity\MaitriseUser', 'notes')
                                ->andWhere('notes.nonConcerne = :nonConcerne')
                                ->setParameter('nonConcerne', false)
                                ->leftJoin('notes.rechercheParcoursDetails', 'etape')
                                ->andWhere('etape.id IN (:ids)')
                                ->setParameter('ids', $etapesId)
                                ->andWhere('notes.user = :user')
                                ->setParameter('user', $user)
                         ->groupBy('etape.id')
                         ->orderBy('etape.order');
    }
}
