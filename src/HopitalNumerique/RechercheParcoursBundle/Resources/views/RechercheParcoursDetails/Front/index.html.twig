{% extends 'HopitalNumeriqueCoreBundle::layout.html.twig' %}

{% block metadesc %}Page de recherche par parcours{% endblock %}
{% block metakeywords %}recherche par parcours{% endblock %}

{% block stylesheets %}
    {{parent()}}
    {% stylesheets output="compiled/hopitalnumerique-recherche-parcours-details-front-index.css" filter="cssrewrite, ?yui_css"
        "@fancybox_css"
        'bundles/hopitalnumeriquerechercheparcours/css/front/style.css'
        'bundles/nodevoadmin/css/custom-jquery-ui.min.css'
        'bundles/nodevoadmin/plugins/nodevoLoader/nodevoLoader.css'
    %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block javascripts %}
    {% javascripts output="compiled/hopitalnumerique-recherche-parcours-details-front-index.js" 
        "@jquery_js"
        "@jquery_ui_js"
        "@fancybox_js"
        "@enquire_js"
        'bundles/nodevoadmin/plugins/nodevoLoader/nodevoLoader.js'
    %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script type="text/javascript">
        var loader;

        $(document).ready(function() {
            calculNoteMoyenne();

            //Récupération du tableau de note jsonifié
            var notes = jQuery.parseJSON( $("#note-json").val() );

            //Pour chaque note, setage du slider avec la valeur associée
            $('.note').each(function(){
                //Slider
                $(this).children( ".slider-range-min" ).slider({
                    range: "min",
                    value: notes[$(this).data('id')],
                    min: 0,
                    max: 100,
                    //A la création on set les couleurs
                    create: function(event, ui){
                        var couleur;
                        //Choix de la couleur à appliquer
                        if(parseInt(notes[$(this).parent('.note').data('id')], 0) < 33)
                            couleur = "red";
                        else if(parseInt(notes[$(this).parent('.note').data('id')], 0) < 67)
                            couleur = "yellow";
                        else
                            couleur = "green";

                        $( "#pourcentage-" + $(this).parent('.note').data('id') ).attr("class", function(i, val){
                            return 'pourcentage ' + couleur;
                        });
                    },
                    //Sauvegarde de la note en base
                    stop: function(event, ui){
                        loader = $(this).parent('.note').nodevoLoader();
                        loader.start();

                        $.ajax({
                            url      : $("#sauvegarde-note-url").val(),
                            data     : {
                                idObjet                  : $(this).parent('.note').data('id'),
                                value                    : ui.value,
                                rechercheParcoursDetails : $("#etape-selected").val()
                            },
                            type     : 'POST',
                            dataType : 'json',
                            success : function( data ){
                                loader.finished();
                            }
                        });
                    },
                    //Calcul de la moyenne + modifs de la couleur
                    slide: function( event, ui ) {
                        var couleur;
                        //Choix de la couleur à appliquer
                        if(parseInt(ui.value, 0) < 33)
                            couleur = "red";
                        else if(parseInt(ui.value, 0) < 67)
                            couleur = "yellow";
                        else
                            couleur = "green";

                        $( "#pourcentage-" + $(this).parent('.note').data('id') ).val( ui.value );
                        $( "#pourcentage-" + $(this).parent('.note').data('id') ).attr("class", function(i, val){
                            return 'pourcentage ' + couleur;
                        });
                        calculNoteMoyenne();
                    }
                });
                
                //Label
                $( "#pourcentage-" + $(this).data('id') ).val( $( "#slider-range-min-" + $(this).data('id') ).slider( "value" ) );
            });
        });

        //Fancybox de la synthese
        $('a.synthese').fancybox({
            'padding'   : 0,
            'autoSize'  : false,
            'width'     : '80%',
            'scrolling' : 'no'
        });

        //fancybox daffichage de la synthese
        enquire.register("screen and (max-width: 991px)", {
            match : function() {
                $(function() {
                    $(document).unbind('click.fb-start');
                    $('a.synthese').attr('target','_blank');
                });
            },
            unmatch : function() {
                $(function() {
                    $('a.synthese').fancybox({
                        'padding'   : 0,
                        'autoSize'  : false,
                        'width'     : '80%',
                        'scrolling' : 'no'
                    });
                    $('a.synthese').attr('target','');
                });
            }
        });

        function calculNoteMoyenne()
        {
            var noteTotal = 0;
            var compteur  = 0;

            $(".resultats-points-durs .note .pourcentage").each(function(){
                noteTotal += parseInt($(this).val(),0);
                compteur++;
            });

            var couleur;
            //Choix de la couleur à appliquer
            if(compteur == 0 || parseInt(noteTotal / compteur, 0) < 33)
                couleur = "red";
            else if(parseInt(noteTotal / compteur, 0) < 67)
                couleur = "yellow";
            else
                couleur = "green";

            //Calcul de la moyenne
            if(compteur != 0)
            {
                $("#note-moyenne span").html(parseInt(noteTotal / compteur, 0) + ' %');
                $("#note-moyenne span").attr("class", function(i, val){
                    return couleur;
                });
                $("#recherche-par-parcours-details .en-tete .en-tete-scroll .chemin-de-fer .bloc-etape-selected a").attr("class", function(i, val){
                    return couleur;
                });
            }
            else
            {
                $("#note-moyenne span").html(parseInt("0", 0) + ' %');
                $("#note-moyenne span").attr("class", function(i, val){
                    return couleur;
                });
                $("#recherche-par-parcours-details .en-tete .en-tete-scroll .chemin-de-fer .bloc-etape-selected a").attr("class", function(i, val){
                    return couleur;
                });
            }
        }
    </script>
{% endblock %}

{% block body %}
    <div class="col-md-12" id="recherche-par-parcours-details">
        
        <div class="row">
            <div class="col-md-11">
                <h3>{{rechercheParcours.reference.libelle}}</h3>
            </div>
            <div class="col-md-1 toolbar">
                <a class="btn btn-default" href="{{ path('hopital_numerique_recherche_parcours_homepage_front') }}" title="Retour à la recherche guidée"><i class="fa fa-reply"></i></a>
            </div>
        </div>
        
        <div class="en-tete">
            <div class="en-tete-scroll">
                {# Include du chemin de fer #}
                {% include 'HopitalNumeriqueRechercheParcoursBundle:RechercheParcoursDetails:Front/partials/chemin_de_fer.html.twig' with { 'rechercheParcours' : rechercheParcours, 'etapeSelected' : etapesSelected.id } %}
            </div>

            <div class="description">
                <div class="col-md-8 row">
                    <p>
                        {{etapesSelected.description}}
                    </p>
                </div>
                <div class="col-md-4">
                    {% if app.user %}
                        <div id="note-moyenne" class="note">
                            <span title="Taux de maîtrise de l'étape"></span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="clearfix"></div>
        </div>

        <div class="resultats-points-durs">
            <input type="hidden" id="app-user" value="{% if app.user %}{{app.user.id}}{% else %}0{% endif %}" />
            <input type="hidden" id="etape-selected" value="{{etapesSelected.id}}" />
            <input type="hidden" id="sauvegarde-note-url" value="{{path("hopital_numerique_recherche_parcours_details_save_front")}}" />
            {% if app.user %}
                {# Include du body en mode connecté #}
                {% include 'HopitalNumeriqueRechercheParcoursBundle:RechercheParcoursDetails:Front/partials/body-online.html.twig' with { 'rechercheParcours' : rechercheParcours, 'etapeSelected' : etapesSelected.id } %}

                {# Input hidden permettant de stocker le tableau des notes triés par objet #}
                <input type="hidden" id="note-json" value="{{ notesJSON }}" />
            {% else %}
                {# Include du body en mode non connecté #}
                {% include 'HopitalNumeriqueRechercheParcoursBundle:RechercheParcoursDetails:Front/partials/body-offline.html.twig' with { 'rechercheParcours' : rechercheParcours, 'etapeSelected' : etapesSelected.id } %}
            {% endif %}
        </div>
        
    </div>
{% endblock %}