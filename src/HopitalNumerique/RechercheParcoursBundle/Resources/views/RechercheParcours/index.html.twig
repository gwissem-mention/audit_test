{% extends 'NodevoAdminBundle::admin.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets output="compiled/hopitalnumerique-recherche-parcours-index.css" filter="cssrewrite, ?yui_css" 
        "@select2_css" 
        "@fancybox_css"
        "@validationEngine_css"
        "@jquery_toggles_css"
        'bundles/nodevoadmin/css/jquery.nestable.css'
        'bundles/nodevoadmin/css/toggles.css'
    %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
<style type="text/css">

/* Gestion des questions */
#questions .text-muted {margin-right:120px}

/* Gestion des reponses */
#reponses .text-muted {margin-right:60px}

/* Affichage d'un résultat */
#resultat-detail h3{margin-left:30px;}

/* Affichage de la liste des questions/réponses d'un outil */
#listeChapitres h2{background: #cfcfcf; margin-top: 20px; padding: 5px 20px; color: #6f3596}
#listeChapitres h2 span{color:#4d4d4d; font-size: 20px; padding:10px 0;}
#listeChapitres .sous-chapitre .row{padding-left:20px;}
#listeChapitres .question{font-weight: bold; margin-left: 5px}
#listeChapitres .question span{font-weight: normal;}
#listeChapitres h3{background: #efefef; margin-top: 20px; padding: 5px 20px;color: #6f3596}
#listeChapitres h3 span{color:#4d4d4d; font-size: 17px; padding:5px 0;}

/* Affichage des réponses */
#designForForm {border-bottom:1px solid #E5E5E5;}
.toggle .toggle-on, .toggle .toggle-off{color:#1DA4C5;}
.toggle .toggle-on.active, .toggle .toggle-off.active{color:#FFFFFF;}
.question select{padding: 2px 0; height: 28px;}
</style>
{% endblock %}

{% block javascripts %}
    {{parent()}}
    {% javascripts output="compiled/hopitalnumerique-recherche-parcours-index.js" 
        "@select2_js" 
        "@fancybox_js" 
        "@nestable_js"
        "@tinymce_js"
        "@jquery_toggles_js"
        "@validationEngine_js"
        "@json_js"
        'bundles/nodevogestionnairemedia/js/moxiemanager/js/moxman.loader.min.js'
        'bundles/nodevogestionnairemedia/js/MoxieManager.js'
    %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
<script type="text/javascript">
    $(document).ready(function() {
    
    //Création et gestion de l'arborescence des chapitres
    if( $('#recherchesParcours').length > 0 ){
        $('#recherchesParcours').nestable({'maxDepth':1,'group':0}).on('change', function() {
            var serializedDatas = $(this).nestable('serialize');

            $.ajax({
                url  : $('#order-question-url').val(),
                data : {
                    datas : serializedDatas
                },
                type     : 'POST',
                dataType : 'json',
                success  : function( data ){
                    //console.log( 'reorder executed' );
                }
            });
        });
    }

    //Fancybox
    if( $('.fancy').length > 0 )
        initFancyBox();
    
    //bind de Validation Engine
    if( $('form.toValidate').length > 0 )
        $('form.toValidate').validationEngine();
});

// Initialise la fancybox
function initFancyBox()
{
    $('.fancy').fancybox({
            'padding'   : 0,
            'autoSize'  : false,
            'width'     : '80%',
            'height'    : '600px',
            'scrolling' : 'no',
            'modal'     : true
        });
}

//Toogle Block and manage classes
function toggle( block )
{
    $('.'+block).slideToggle();

    if ( $('.'+block).is(':visible') ){
        $('.'+block).find('input').addClass('validate[required,maxSize[255]]');
        $('.'+block).find('select').addClass('validate[required]');
    }else{
        $('.'+block).find('input').removeClass('validate[required,maxSize[255]]');
        $('.'+block).find('select').removeClass('validate[required]');
    }   
}


//Supprime le contenu en cours de visualisation
function deleteReponse( id, url )
{
    apprise('Attention, cette opération est irréversible, êtes-vous sur de vouloir continuer ?', {'verify':true,'textYes':'Oui','textNo':'Non'}, function(r) {
        if(r) { 
            $.ajax({
                url  : url,
                data : {
                    id : id
                },
                type     : 'POST',
                dataType : 'json',
                success  : function( data ){
                    if( data.success ){
                        if( data.childs == 0 ){
                            $('#questions #question-' + id).parent().parent().find('button').each(function(){
                                $(this).remove();
                            })
                        }

                        //supprime l'élément dans le HTML
                        $('#questions #question-' + id).remove();

                        if( $('#questions ol li').length == 0)
                            $('#questions .designForBlank').show();
                    }
                }
            });
        }
    });
}

//Selectionne un chapitre et charge l'ensemble des questions liés
function selectQuestion( id, url )
{
    $('#details .selectionQuestion').hide();
    
    //bind de Validation Engine
    if( $('form.toValidate').length > 0 )
        $('form.toValidate').validationEngine();

    $.ajax({
        url     : url,
        type    : 'POST',
        success : function( data ){
            $('#details .results').html( data );
        }
    });

    $('#details .question').val( id );
}

//Selectionne un chapitre et charge l'ensemble des questions liés
function addReponse( url )
{
    if ( $('#designForForm form').validationEngine('validate') ) {
        $.ajax({
            url     : url,
            data    :  $('#designForForm form').serialize(),
            type    : 'POST',
            success : function( data ){
                //Ajout de la réponse
                $('#details-dd ol:first').append( data );
                //window.location.reload();
            }
        });
    }
}
</script>
{% endblock %}

{% block h1Title %}
    Gestion de la recherche par parcours
{% endblock %}

{% block toolbarButton %}
{% endblock %}

{% block body %}

    <div class="col-sm-12">

        <div class="panel-body">

            <div class="col-md-12">
                <div class="well well-lg">
                    <div class="dd" id="recherchesParcours">
                        <ol class="dd-list">
                            {% import _self as mySelf %}
                            {% for rechercheParcours in recherchesParcours %}
                                {{ mySelf.buildTree(rechercheParcours) }}
                            {% endfor %}
                        </ol>
                    </div>
                </div>

                <input type="hidden" id="order-question-url" value="{{path('hopital_numerique_expbesoin_reorderquestion')}}" />

            </div>

            <div class="clearfix"></div>

            <div class="col-md-12">
                <div class="well well-lg" id="details">
                    <span class="selectionQuestion">Vous devez sélectionner une question avant de visualiser les réponses.</span>
                    <div class="results">
                        
                    </div>
                    <input type="hidden" class="question" value="0" />
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% macro buildTree(rechercheParcours) %}
    <li class="dd-item dd3-item" data-id="{{rechercheParcours.id}}" id="rechercheParcours-{{rechercheParcours.id}}" >
        <div class="dd-handle dd3-handle"></div>
        <div class="dd3-content">
            <a href="javascript:selectQuestion({{rechercheParcours.id}}, '{{path('hopital_numerique_recherche_parcours_details_index', {'id':rechercheParcours.id})}}')">{{rechercheParcours.reference.libelle}}</a>
        </div>
        <div class="dd3-actions">
            <div onclick="deleteQuestion( {{rechercheParcours.id}}, '{{path('hopital_numerique_expbesoin_deletequestion', {'id':rechercheParcours.id})}}' );" class="pull-right dd3-trash"><i class="fa fa-trash-o"></i></div>
            <div onclick="editQuestion( {{rechercheParcours.id}}, '{{path('hopital_numerique_expbesoin_editquestion', {'id':rechercheParcours.id})}}' );" class="pull-right dd3-edit question-edit"><i class="fa fa-edit"></i></div>
        </div>
    </li>
{% endmacro %}