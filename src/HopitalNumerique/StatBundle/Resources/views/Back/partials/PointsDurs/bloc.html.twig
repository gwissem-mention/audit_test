{# Tableau des stats des points durs #}
{% set option = 'point-dur' %}
<div class="panel panel-default gray">
    <a data-toggle="collapse" data-parent="#accordion" href="#collapsePointDur" class="collapsed" id="tableau_point_dur">
        <div class="panel-heading"><h4>Vue des points durs des parcours</h4></div>
    </a>
    <div id="collapsePointDur" class="collapse" style="height: 0px;">

        <div class="panel-body">
            <div class="col-md-12">
                <div class="form-group">
                    
                    {# Points durs #}
                    <div id="point-dur-filtres">
                        <form id ="form-point-dur" action="{{path('hopital_numerique_stat_point_dur_export_csv')}}" method="POST">
                            <div class="row">
                                {# Date de début #}
                                <div class="col-md-6">
                                    <label for="datepicker-datedebut">Date de début: </label><input type="text" class="form-control" id="datepicker-datedebut" name="datedebut">
                                </div>
                                {# Date de fin #}
                                <div class="col-md-6">
                                    <label for="datepicker-datefin">Date de fin: </label><input type="text" class="form-control" name="dateFin" id="datepicker-datefin">
                                </div>
                            </div>
                            <div class="row">
                                {# Select du choix du périmetre fonctionnel #}
                                <div class="col-md-12">
                                    <label class="control-label required" for="perimFonctionnelles">
                                        Choix du perimètre fonctionnel
                                        <span title="Ce champ est requis" style="color:red;font-size:10px">*</span>
                                    </label>
                                    <div class="blocParamFonct">
                                        <select name="perimFonctionnellesSelect" id="perimFonctionnelles" class="form-control validate[required]" data-prompt-position="bottomLeft">
                                            <option value=""> - </option>
                                            {% for paramFonct in paramsFonct %}
                                                <option value="{{paramFonct.id}}" >{{paramFonct.libelle}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                {# Select du choix entre profil et type ES #}
                                <div class="col-md-12">
                                    <label class="control-label required" for="profilType">
                                        Choix entre le profil et le type ES
                                        <span title="Ce champ est requis" style="color:red;font-size:10px">*</span>
                                    </label>
                                    <div class="blocProfilType">
                                        <select name="profilTypeSelect" id="profilType" class="form-control validate[required]" data-prompt-position="bottomLeft">
                                            <option value=""> - </option>
                                            <option value="profil"> Profil </option>
                                            <option value="typeES"> Type établissement </option>s
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="row">
                            {# Boutton de génération du tableau #}
                            <div class="col-md-12 button-generation">
                                <div id="export-csv-point-dur" onclick="exportCSV();" class="finish btn btn-primary pull-right" title="Export CSV" ><i class="fa fa-download"></i></div>
                                <div id="generation-tableau-point-dur" onclick="generation( '{{path('hopital_numerique_stat_point_dur_generate_tableau')}}' );" class="finish btn btn-success pull-right" title="Générer le tableau" ><i class="fa fa-bar-chart-o"></i></div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    {# Bloc de génération du tableau #}
                    <div id="point-dur-tableau">
                    </div>

                </div>
            </div>  
        </div>
    </div>
</div>

<style type="text/css">
#point-dur-filtres .button-generation {margin-top: 15px;}
#point-dur-filtres {padding-bottom:15px;border-bottom: 1px solid #EDEEF0}
#point-dur-filtres label{margin-top: 10px;margin-bottom: 2px;}
#point-dur-tableau {margin-top: 15px;}

</style>

<script type="text/javascript">
    $(document).ready(function() { 

        //bind de Validation Engine
        $('form.toValidate').validationEngine();

        //Date début
        $( "#datepicker-datedebut" ).datepicker({
            defaultDate: "now",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datefin" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#datepicker-datedebut" ).datepicker( "option", "showAnim", "fadeIn" );

        //Date de fin
        $( "#datepicker-datefin" ).datepicker({
            defaultDate: "+1d",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datedebut" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $( "#datepicker-datefin" ).datepicker( "option", "showAnim", "fadeIn" );

        $("#clickExportCSV").on('click', function (event) {
            // CSV
            exportTableToCSV.apply(this, [$('#point-dur-table'), 'export.csv']);
        });
    });

    function exportCSV()
    {
        if ( $('#form-point-dur').validationEngine('validate') ) 
        {
            $('form').submit();
        }
    }

    function generation(url)
    {
        if ( $('#form-point-dur').validationEngine('validate') ) 
        {
            var loaderButton  = $('#generation-tableau-point-dur').nodevoLoader().start();
            var loaderTableau = $('#point-dur-tableau').nodevoLoader().start();

            $.ajax({
                url     : url,
                data    :  $('#form-point-dur').serialize(),
                type    : 'POST',
                success : function( data ){
                    //Ajout de la réponse
                    $('#point-dur-tableau').html( data );
                    loaderButton.finished();
                    loaderTableau.finished();
                }
            });
        }
    }
</script>