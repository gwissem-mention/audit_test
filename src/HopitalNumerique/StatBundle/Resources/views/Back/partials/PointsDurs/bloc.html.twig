{# Tableau des stats des points durs #}
<div class="panel panel-default gray">
    <a data-toggle="collapse" data-parent="#accordion" href="#collapsePointDur" class="collapsed" id="tableau_point_dur">
        <div class="panel-heading"><h4>Point dur</h4></div>
    </a>
    <div id="collapsePointDur" class="collapse" style="height: 0px;">

        <div class="panel-body">
            <div class="col-md-12">
                <div class="form-group">
                    
                    {# Points durs #}
                    <div id="point-dur-filtres">
                        <form id ="form-point-dur" action="{{path('hopital_numerique_stat_point_dur_export_csv')}}" method="POST">
                            <div class="row">
                                {# Date de début #}
                                <div class="col-md-6">
                                    <label for="datepicker-datedebut-pointDur">Date de début: </label><input type="text" class="form-control" id="datepicker-datedebut-pointDur" name="datedebut-pointDur">
                                </div>
                                {# Date de fin #}
                                <div class="col-md-6">
                                    <label for="datepicker-datefin-pointDur">Date de fin: </label><input type="text" class="form-control" name="dateFin-pointDur" id="datepicker-datefin-pointDur">
                                </div>
                            </div>
                            <div class="row">
                                {# Select du choix du périmetre fonctionnel #}
                                <div class="col-md-12">
                                    <label class="control-label required" for="perimFonctionnelles">
                                        Choix du perimètre fonctionnel
                                        <span title="Ce champ est requis" style="color:red;font-size:10px">*</span>
                                    </label>
                                    <div class="blocParamFonct">
                                        <select name="perimFonctionnellesSelect" id="perimFonctionnelles" class="form-control validate[required]" data-prompt-position="bottomLeft">
                                            <option value=""> - </option>
                                            {% for paramFonct in paramsFonct %}
                                                <option value="{{paramFonct.id}}" >{{paramFonct.libelle}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                {# Select du choix entre profil et type ES #}
                                <div class="col-md-12">
                                    <label class="control-label required" for="profilType">
                                        Choix entre le profil et le type ES
                                        <span title="Ce champ est requis" style="color:red;font-size:10px">*</span>
                                    </label>
                                    <div class="blocProfilType">
                                        <select name="profilTypeSelect" id="profilType" class="form-control validate[required]" data-prompt-position="bottomLeft">
                                            <option value=""> - </option>
                                            <option value="profil"> Profil </option>
                                            <option value="typeES"> Type établissement </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="row">
                            {# Boutton de génération du tableau #}
                            <div class="col-md-12 button-generation">
                                <div id="export-csv-point-dur" onclick="exportCSVPointDur();" class="finish btn btn-primary pull-right" title="Export CSV" ><i class="fa fa-download"></i></div>
                                <div id="generation-tableau-point-dur" onclick="generationPointDur( '{{path('hopital_numerique_stat_point_dur_generate_tableau')}}' );" class="finish btn btn-success pull-right" title="Générer le tableau" ><i class="fa fa-bar-chart-o"></i></div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    {# Bloc de génération du tableau #}
                    <div id="point-dur-tableau">
                    </div>

                </div>
            </div>  
        </div>
    </div>
</div>

<style type="text/css">
#point-dur-filtres .button-generation {margin-top: 15px;}
#point-dur-filtres {padding-bottom:15px;border-bottom: 1px solid #EDEEF0}
#point-dur-filtres label{margin-top: 10px;margin-bottom: 2px;}
#point-dur-tableau {margin-top: 15px;}

#item-requete-filtres .button-generation {margin-top: 15px;}
#item-requete-filtres {padding-bottom:15px;border-bottom: 1px solid #EDEEF0}
#item-requete-filtres label{margin-top: 10px;margin-bottom: 2px;}
#item-requete-tableau {margin-top: 15px;}

#requete-fantome-filtres .button-generation {margin-top: 15px;}
#requete-fantome-filtres {padding-bottom:15px;border-bottom: 1px solid #EDEEF0}
#requete-fantome-filtres label{margin-top: 10px;margin-bottom: 2px;}
#requete-fantome-tableau {margin-top: 15px;}


/* Popup details */
ol.arbo-requete{padding:0;list-style-type: none}
ol.arbo-requete ol{padding-left: 30px; list-style-type: none}
ol.arbo-requete li.level0 span{ text-transform: uppercase; color: #703695; font-size: 16px; font-weight: bold }
ol.arbo-requete li.level0 ol li.level1 span{ text-transform: none; color: #000000; font-size: 12px; font-weight: bold }
ol.arbo-requete li.level0 ol li.level1 ol li.level2 span{ font-size: 12px; font-weight: normal; color:#070707; }
ol.arbo-requete li.level0 ol li.level1 ol li.level2 ol li.level3 span{ font-style:italic; color:#070707; }
</style>

<script type="text/javascript">
    $(document).ready(function() { 

        //bind de Validation Engine
        $('form.toValidate').validationEngine();

        //---Point dur

        //Date début
        $( "#datepicker-datedebut-pointDur" ).datepicker({
            defaultDate: "now",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datefin-pointDur" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#datepicker-datedebut-pointDur" ).datepicker( "option", "showAnim", "fadeIn" );

        //Date de fin
        $( "#datepicker-datefin-pointDur" ).datepicker({
            defaultDate: "+1d",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datedebut-pointDur" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $( "#datepicker-datefin-pointDur" ).datepicker( "option", "showAnim", "fadeIn" );

        //---Item requete

        //Date début
        $( "#datepicker-datedebut-itemRequete" ).datepicker({
            defaultDate: "now",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datefin-itemRequete" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#datepicker-datedebut-itemRequete" ).datepicker( "option", "showAnim", "fadeIn" );

        //Date de fin
        $( "#datepicker-datefin-itemRequete" ).datepicker({
            defaultDate: "+1d",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datedebut-itemRequete" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $( "#datepicker-datefin-itemRequete" ).datepicker( "option", "showAnim", "fadeIn" );

        //---Requete fantome

        //Date début
        $( "#datepicker-datedebut-requeteFantom" ).datepicker({
            defaultDate: "now",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datefin-requeteFantom" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#datepicker-datedebut-requeteFantom" ).datepicker( "option", "showAnim", "fadeIn" );

        //Date de fin
        $( "#datepicker-datefin-requeteFantom" ).datepicker({
            defaultDate: "+1d",
            changeMonth: true,
            numberOfMonths: 1,
            dateFormat: "dd-mm-yy",
            onClose: function( selectedDate ) {
                $( "#datepicker-datedebut-requeteFantom" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $( "#datepicker-datefin-requeteFantom" ).datepicker( "option", "showAnim", "fadeIn" );
    });

    function exportCSVPointDur()
    {
        if ( $('#form-point-dur').validationEngine('validate') ) 
        {
            $('#form-point-dur').submit();
        }
    }

    function generationPointDur(url)
    {
        if ( $('#form-point-dur').validationEngine('validate') ) 
        {
            var loaderButton  = $('#generation-tableau-point-dur').nodevoLoader().start();
            var loaderTableau = $('#point-dur-tableau').nodevoLoader().start();

            $.ajax({
                url     : url,
                data    :  $('#form-point-dur').serialize(),
                type    : 'POST',
                success : function( data ){
                    //Ajout de la réponse
                    $('#point-dur-tableau').html( data );
                    loaderButton.finished();
                    loaderTableau.finished();
                }
            });
        }
    }

    function exportCSVItemRequete()
    {
        if ( $('#form-item-requete').validationEngine('validate') ) 
        {
            $('#form-item-requete').submit();
        }
    }

    function generationItemRequete(url)
    {
        if ( $('#form-item-requete').validationEngine('validate') ) 
        {
            var loaderButton  = $('#generation-tableau-item-requete').nodevoLoader().start();
            var loaderTableau = $('#item-requete-tableau').nodevoLoader().start();

            $.ajax({
                url     : url,
                data    :  $('#form-item-requete').serialize(),
                type    : 'POST',
                success : function( data ){
                    //Ajout de la réponse
                    $('#item-requete-tableau').html( data );
                    loaderButton.finished();
                    loaderTableau.finished();
                }
            });
        }
    }

    function generationRequeteFantom(url)
    {
        if ( $('#form-requete-fantome').validationEngine('validate') ) 
        {
            var loaderButton  = $('#generation-tableau-requete-fantome').nodevoLoader().start();
            var loaderTableau = $('#requete-fantome-tableau').nodevoLoader().start();

            $.ajax({
                url     : url,
                data    :  $('#form-requete-fantome').serialize(),
                type    : 'POST',
                success : function( data ){
                    //Ajout de la réponse
                    $('#requete-fantome-tableau').html( data );
                    loaderButton.finished();
                    loaderTableau.finished();
                }
            });
        }
    }

    /**
     * Affiche l'élément en mode récursif
     */
    function showElementRecursive( destItem )
    {
        $(destItem).removeClass('hide');

        if ( $(destItem).parent().parent().hasClass('hide') )
            showElementRecursive( $(destItem).parent().parent() );
    }


    /**
     * Prend en compte la requete par défaut ou la requete active
     */
    function handleRefs()
    {
        $("#item-requete-table .requete-fantome-arbo").each(function(){

            var requeteFantome = $(this);
            var refs = $.parseJSON( requeteFantome.find(".requete-refs").val() );

            $.each(refs, function(key, val){
                $.each(val.reverse(), function( key, item ){
                    element = requeteFantome.find('.arbo-requete .element-'+item);
                    if( $(element).hasClass('hide') ){
                        //affiche l'élément
                        showElementRecursive( $(element) );

                        //si c'est un parent, on show ces enfants (NON recursif)
                        $(element).find('li.hide').removeClass('hide');
                    }
                });
            });
        });
    }
</script>